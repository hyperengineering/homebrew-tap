# typed: false
# frozen_string_literal: true

# This file was generated by GoReleaser. DO NOT EDIT.
class Engram < Formula
  desc "Centralized lore persistence and synchronization service"
  homepage "https://github.com/hyperengineering/engram"
  version "1.4.6"
  license "MIT"

  on_macos do
    if Hardware::CPU.intel?
      url "https://github.com/hyperengineering/engram/releases/download/v1.4.6/engram_darwin_amd64.tar.gz"
      sha256 "821e241c87d8450ba4efc40aa4d545271a4eb2830894a233a00205154aafc71f"

      def install
        bin.install "engram"
        # Install wrapper script
        (bin/"engram-wrapper").write <<~EOS
          #!/bin/bash
          set -e
          ENV_FILE="#{etc}/engram/environment"
          if [[ -f "$ENV_FILE" ]]; then
            set -a
            source "$ENV_FILE"
            set +a
          fi
          exec "#{bin}/engram" "$@"
        EOS
        (bin/"engram-wrapper").chmod 0755

        # Create config directory and environment template
        (etc/"engram").mkpath
        (var/"engram").mkpath
        (var/"log/engram").mkpath

        # Install environment template (don't overwrite existing)
        unless (etc/"engram/environment").exist?
          (etc/"engram/environment").write <<~EOS
            # Engram Environment Variables
            # Permissions: 600 (chmod 600 #{etc}/engram/environment)

            # Required: API key for authenticating clients
            # Generate: openssl rand -hex 32
            ENGRAM_API_KEY=

            # Required: OpenAI API key for embedding generation
            # Get from: https://platform.openai.com/api-keys
            OPENAI_API_KEY=

            # Optional: Override default port (8080)
            # ENGRAM_PORT=8080

            # Optional: Override default host (localhost)
            # ENGRAM_HOST=0.0.0.0

            # Optional: S3-compatible storage for snapshot distribution
            # ENGRAM_SNAPSHOT_BUCKET=
            # ENGRAM_S3_ENDPOINT=
            # ENGRAM_S3_ACCESS_KEY=
            # ENGRAM_S3_SECRET_KEY=
          EOS
          (etc/"engram/environment").chmod 0600
        end
      end
    end
    if Hardware::CPU.arm?
      url "https://github.com/hyperengineering/engram/releases/download/v1.4.6/engram_darwin_arm64.tar.gz"
      sha256 "21df1ca26d0ecbec80121f050e05e8169bf295578f0de85c073649531f889c37"

      def install
        bin.install "engram"
        # Install wrapper script
        (bin/"engram-wrapper").write <<~EOS
          #!/bin/bash
          set -e
          ENV_FILE="#{etc}/engram/environment"
          if [[ -f "$ENV_FILE" ]]; then
            set -a
            source "$ENV_FILE"
            set +a
          fi
          exec "#{bin}/engram" "$@"
        EOS
        (bin/"engram-wrapper").chmod 0755

        # Create config directory and environment template
        (etc/"engram").mkpath
        (var/"engram").mkpath
        (var/"log/engram").mkpath

        # Install environment template (don't overwrite existing)
        unless (etc/"engram/environment").exist?
          (etc/"engram/environment").write <<~EOS
            # Engram Environment Variables
            # Permissions: 600 (chmod 600 #{etc}/engram/environment)

            # Required: API key for authenticating clients
            # Generate: openssl rand -hex 32
            ENGRAM_API_KEY=

            # Required: OpenAI API key for embedding generation
            # Get from: https://platform.openai.com/api-keys
            OPENAI_API_KEY=

            # Optional: Override default port (8080)
            # ENGRAM_PORT=8080

            # Optional: Override default host (localhost)
            # ENGRAM_HOST=0.0.0.0

            # Optional: S3-compatible storage for snapshot distribution
            # ENGRAM_SNAPSHOT_BUCKET=
            # ENGRAM_S3_ENDPOINT=
            # ENGRAM_S3_ACCESS_KEY=
            # ENGRAM_S3_SECRET_KEY=
          EOS
          (etc/"engram/environment").chmod 0600
        end
      end
    end
  end

  on_linux do
    if Hardware::CPU.intel? && Hardware::CPU.is_64_bit?
      url "https://github.com/hyperengineering/engram/releases/download/v1.4.6/engram_linux_amd64.tar.gz"
      sha256 "0e6ef0716b5160c2a48890ea7f6b528ebd2437abe70cd42ec6d13bb39d064aa3"
      def install
        bin.install "engram"
        # Install wrapper script
        (bin/"engram-wrapper").write <<~EOS
          #!/bin/bash
          set -e
          ENV_FILE="#{etc}/engram/environment"
          if [[ -f "$ENV_FILE" ]]; then
            set -a
            source "$ENV_FILE"
            set +a
          fi
          exec "#{bin}/engram" "$@"
        EOS
        (bin/"engram-wrapper").chmod 0755

        # Create config directory and environment template
        (etc/"engram").mkpath
        (var/"engram").mkpath
        (var/"log/engram").mkpath

        # Install environment template (don't overwrite existing)
        unless (etc/"engram/environment").exist?
          (etc/"engram/environment").write <<~EOS
            # Engram Environment Variables
            # Permissions: 600 (chmod 600 #{etc}/engram/environment)

            # Required: API key for authenticating clients
            # Generate: openssl rand -hex 32
            ENGRAM_API_KEY=

            # Required: OpenAI API key for embedding generation
            # Get from: https://platform.openai.com/api-keys
            OPENAI_API_KEY=

            # Optional: Override default port (8080)
            # ENGRAM_PORT=8080

            # Optional: Override default host (localhost)
            # ENGRAM_HOST=0.0.0.0

            # Optional: S3-compatible storage for snapshot distribution
            # ENGRAM_SNAPSHOT_BUCKET=
            # ENGRAM_S3_ENDPOINT=
            # ENGRAM_S3_ACCESS_KEY=
            # ENGRAM_S3_SECRET_KEY=
          EOS
          (etc/"engram/environment").chmod 0600
        end
      end
    end
    if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
      url "https://github.com/hyperengineering/engram/releases/download/v1.4.6/engram_linux_arm64.tar.gz"
      sha256 "1d7ce676721d25e98b657f27da78752fea6c45402330aa40613286b39b719853"
      def install
        bin.install "engram"
        # Install wrapper script
        (bin/"engram-wrapper").write <<~EOS
          #!/bin/bash
          set -e
          ENV_FILE="#{etc}/engram/environment"
          if [[ -f "$ENV_FILE" ]]; then
            set -a
            source "$ENV_FILE"
            set +a
          fi
          exec "#{bin}/engram" "$@"
        EOS
        (bin/"engram-wrapper").chmod 0755

        # Create config directory and environment template
        (etc/"engram").mkpath
        (var/"engram").mkpath
        (var/"log/engram").mkpath

        # Install environment template (don't overwrite existing)
        unless (etc/"engram/environment").exist?
          (etc/"engram/environment").write <<~EOS
            # Engram Environment Variables
            # Permissions: 600 (chmod 600 #{etc}/engram/environment)

            # Required: API key for authenticating clients
            # Generate: openssl rand -hex 32
            ENGRAM_API_KEY=

            # Required: OpenAI API key for embedding generation
            # Get from: https://platform.openai.com/api-keys
            OPENAI_API_KEY=

            # Optional: Override default port (8080)
            # ENGRAM_PORT=8080

            # Optional: Override default host (localhost)
            # ENGRAM_HOST=0.0.0.0

            # Optional: S3-compatible storage for snapshot distribution
            # ENGRAM_SNAPSHOT_BUCKET=
            # ENGRAM_S3_ENDPOINT=
            # ENGRAM_S3_ACCESS_KEY=
            # ENGRAM_S3_SECRET_KEY=
          EOS
          (etc/"engram/environment").chmod 0600
        end
      end
    end
  end

  def caveats
    <<~EOS
      To complete setup:

        1. Configure your API keys:
           nano #{etc}/engram/environment

           Set ENGRAM_API_KEY and OPENAI_API_KEY

        2. Start the service:
           brew services start engram

        3. Verify it's running:
           curl http://localhost:8080/api/v1/health

      Configuration: #{etc}/engram/environment
      Data:          #{var}/engram/
      Logs:          #{var}/log/engram/engram.log
    EOS
  end

  service do
    run [opt_bin/"engram-wrapper"]
    working_dir var/"engram"
    log_path var/"log/engram/engram.log"
    error_log_path var/"log/engram/engram.log"
    keep_alive true
  end

  test do
    system "#{bin}/engram", "version"
  end
end
