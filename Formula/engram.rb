# typed: false
# frozen_string_literal: true

# This file was generated by GoReleaser. DO NOT EDIT.
class Engram < Formula
  desc "Centralized lore persistence and synchronization service"
  homepage "https://github.com/hyperengineering/engram"
  version "1.4.0"
  license "MIT"

  on_macos do
    if Hardware::CPU.intel?
      url "https://github.com/hyperengineering/engram/releases/download/v1.4.0/engram_darwin_amd64.tar.gz"
      sha256 "b96b52ffad6b70423d508f047fd67c7b7b907d1b3817f5b6ab93f6e7fa520320"

      def install
        bin.install "engram"
        # Install wrapper script
        (bin/"engram-wrapper").write <<~EOS
          #!/bin/bash
          set -e
          ENV_FILE="#{etc}/engram/environment"
          if [[ -f "$ENV_FILE" ]]; then
            set -a
            source "$ENV_FILE"
            set +a
          fi
          exec "#{bin}/engram" "$@"
        EOS
        (bin/"engram-wrapper").chmod 0755

        # Create config directory and environment template
        (etc/"engram").mkpath
        (var/"engram").mkpath
        (var/"log/engram").mkpath

        # Install environment template (don't overwrite existing)
        unless (etc/"engram/environment").exist?
          (etc/"engram/environment").write <<~EOS
            # Engram Environment Variables
            # Permissions: 600 (chmod 600 #{etc}/engram/environment)

            # Required: API key for authenticating clients
            # Generate: openssl rand -hex 32
            ENGRAM_API_KEY=

            # Required: OpenAI API key for embedding generation
            # Get from: https://platform.openai.com/api-keys
            OPENAI_API_KEY=

            # Optional: Override default port (8080)
            # ENGRAM_PORT=8080

            # Optional: Override default host (localhost)
            # ENGRAM_HOST=0.0.0.0

            # Optional: S3-compatible storage for snapshot distribution
            # ENGRAM_SNAPSHOT_BUCKET=
            # ENGRAM_S3_ENDPOINT=
            # ENGRAM_S3_ACCESS_KEY=
            # ENGRAM_S3_SECRET_KEY=
          EOS
          (etc/"engram/environment").chmod 0600
        end
      end
    end
    if Hardware::CPU.arm?
      url "https://github.com/hyperengineering/engram/releases/download/v1.4.0/engram_darwin_arm64.tar.gz"
      sha256 "bf2cd700572f3986650115876453d8d147cec820288e5f3b4c0d80bee59d02c1"

      def install
        bin.install "engram"
        # Install wrapper script
        (bin/"engram-wrapper").write <<~EOS
          #!/bin/bash
          set -e
          ENV_FILE="#{etc}/engram/environment"
          if [[ -f "$ENV_FILE" ]]; then
            set -a
            source "$ENV_FILE"
            set +a
          fi
          exec "#{bin}/engram" "$@"
        EOS
        (bin/"engram-wrapper").chmod 0755

        # Create config directory and environment template
        (etc/"engram").mkpath
        (var/"engram").mkpath
        (var/"log/engram").mkpath

        # Install environment template (don't overwrite existing)
        unless (etc/"engram/environment").exist?
          (etc/"engram/environment").write <<~EOS
            # Engram Environment Variables
            # Permissions: 600 (chmod 600 #{etc}/engram/environment)

            # Required: API key for authenticating clients
            # Generate: openssl rand -hex 32
            ENGRAM_API_KEY=

            # Required: OpenAI API key for embedding generation
            # Get from: https://platform.openai.com/api-keys
            OPENAI_API_KEY=

            # Optional: Override default port (8080)
            # ENGRAM_PORT=8080

            # Optional: Override default host (localhost)
            # ENGRAM_HOST=0.0.0.0

            # Optional: S3-compatible storage for snapshot distribution
            # ENGRAM_SNAPSHOT_BUCKET=
            # ENGRAM_S3_ENDPOINT=
            # ENGRAM_S3_ACCESS_KEY=
            # ENGRAM_S3_SECRET_KEY=
          EOS
          (etc/"engram/environment").chmod 0600
        end
      end
    end
  end

  on_linux do
    if Hardware::CPU.intel? && Hardware::CPU.is_64_bit?
      url "https://github.com/hyperengineering/engram/releases/download/v1.4.0/engram_linux_amd64.tar.gz"
      sha256 "730d164c198d33fb3e0f1bb53e769068bb7866ff085314364ac3163452e1835c"
      def install
        bin.install "engram"
        # Install wrapper script
        (bin/"engram-wrapper").write <<~EOS
          #!/bin/bash
          set -e
          ENV_FILE="#{etc}/engram/environment"
          if [[ -f "$ENV_FILE" ]]; then
            set -a
            source "$ENV_FILE"
            set +a
          fi
          exec "#{bin}/engram" "$@"
        EOS
        (bin/"engram-wrapper").chmod 0755

        # Create config directory and environment template
        (etc/"engram").mkpath
        (var/"engram").mkpath
        (var/"log/engram").mkpath

        # Install environment template (don't overwrite existing)
        unless (etc/"engram/environment").exist?
          (etc/"engram/environment").write <<~EOS
            # Engram Environment Variables
            # Permissions: 600 (chmod 600 #{etc}/engram/environment)

            # Required: API key for authenticating clients
            # Generate: openssl rand -hex 32
            ENGRAM_API_KEY=

            # Required: OpenAI API key for embedding generation
            # Get from: https://platform.openai.com/api-keys
            OPENAI_API_KEY=

            # Optional: Override default port (8080)
            # ENGRAM_PORT=8080

            # Optional: Override default host (localhost)
            # ENGRAM_HOST=0.0.0.0

            # Optional: S3-compatible storage for snapshot distribution
            # ENGRAM_SNAPSHOT_BUCKET=
            # ENGRAM_S3_ENDPOINT=
            # ENGRAM_S3_ACCESS_KEY=
            # ENGRAM_S3_SECRET_KEY=
          EOS
          (etc/"engram/environment").chmod 0600
        end
      end
    end
    if Hardware::CPU.arm? && Hardware::CPU.is_64_bit?
      url "https://github.com/hyperengineering/engram/releases/download/v1.4.0/engram_linux_arm64.tar.gz"
      sha256 "258c9d74b6a2247b4310286424ed96a608b3ae7d399c8c2a3cc5ec05404cd28d"
      def install
        bin.install "engram"
        # Install wrapper script
        (bin/"engram-wrapper").write <<~EOS
          #!/bin/bash
          set -e
          ENV_FILE="#{etc}/engram/environment"
          if [[ -f "$ENV_FILE" ]]; then
            set -a
            source "$ENV_FILE"
            set +a
          fi
          exec "#{bin}/engram" "$@"
        EOS
        (bin/"engram-wrapper").chmod 0755

        # Create config directory and environment template
        (etc/"engram").mkpath
        (var/"engram").mkpath
        (var/"log/engram").mkpath

        # Install environment template (don't overwrite existing)
        unless (etc/"engram/environment").exist?
          (etc/"engram/environment").write <<~EOS
            # Engram Environment Variables
            # Permissions: 600 (chmod 600 #{etc}/engram/environment)

            # Required: API key for authenticating clients
            # Generate: openssl rand -hex 32
            ENGRAM_API_KEY=

            # Required: OpenAI API key for embedding generation
            # Get from: https://platform.openai.com/api-keys
            OPENAI_API_KEY=

            # Optional: Override default port (8080)
            # ENGRAM_PORT=8080

            # Optional: Override default host (localhost)
            # ENGRAM_HOST=0.0.0.0

            # Optional: S3-compatible storage for snapshot distribution
            # ENGRAM_SNAPSHOT_BUCKET=
            # ENGRAM_S3_ENDPOINT=
            # ENGRAM_S3_ACCESS_KEY=
            # ENGRAM_S3_SECRET_KEY=
          EOS
          (etc/"engram/environment").chmod 0600
        end
      end
    end
  end

  def caveats
    <<~EOS
      To complete setup:

        1. Configure your API keys:
           nano #{etc}/engram/environment

           Set ENGRAM_API_KEY and OPENAI_API_KEY

        2. Start the service:
           brew services start engram

        3. Verify it's running:
           curl http://localhost:8080/api/v1/health

      Configuration: #{etc}/engram/environment
      Data:          #{var}/engram/
      Logs:          #{var}/log/engram/engram.log
    EOS
  end

  service do
    run [opt_bin/"engram-wrapper"]
    working_dir var/"engram"
    log_path var/"log/engram/engram.log"
    error_log_path var/"log/engram/engram.log"
    keep_alive true
  end

  test do
    system "#{bin}/engram", "version"
  end
end
